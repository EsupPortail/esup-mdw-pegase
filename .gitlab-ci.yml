image: maven:3-jdk-11

variables:
  NB_OF_WAR_TO_KEEP: 3
  MAVEN_OPTS: "-Dhttps.protocols=TLSv1.2 -Dmaven.repo.local=$CI_PROJECT_DIR/.m2/repository -Dorg.slf4j.simpleLogger.log.org.apache.maven.cli.transfer.Slf4jMavenTransferListener=WARN -Dorg.slf4j.simpleLogger.showDateTime=true -Djava.awt.headless=true"
  # workaround pour https://gitlab.com/gitlab-org/gitlab/-/issues/29407
  MAVEN_CLI_OPTS: "-s $CI_PROJECT_DIR/../$CI_PROJECT_NAME.tmp/MAVEN_SETTINGS_XML --batch-mode --errors --show-version $MAVEN_ADDITIONAL_CLI_OPTS"
  RESTART_AFTER_DEPLOY: 1

cache:
  paths:
    - .m2/repository
    - .sonar/cache

#include:
#  - project: 'dn-sied/ci-config'
#    file: '/.gitlab-ci-template.yml'

#variables:
#  MAVEN_ADDITIONAL_CLI_OPTS: "-Pcoverage,production"

build:
  stage: build
  before_script:
    - cat ${TEST_APPLICATION_PROPERTIES} > ${CI_PROJECT_DIR}/src/test/resources/test.properties
    - cat ${CI_PROJECT_DIR}/src/test/resources/test.properties
  script: "mvn $MAVEN_CLI_OPTS -Dsha1=.$CI_COMMIT_SHORT_SHA verify"  

.build_image:
  #before_script:
  #  - export PROJECT_VERSION=mvn $MAVEN_CLI_OPTS help:evaluate -Dexpression=project.version -q -DforceStdout
  image : 
    name: gcr.io/kaniko-project/executor:debug
    entrypoint: [""]
  stage: deploy
  script:
    - mkdir -p /kaniko/.docker
    - echo "{\"auths\":{\"${CI_REGISTRY}\":{\"auth\":\"$(printf "%s:%s" "${CI_REGISTRY_USER}" "${CI_REGISTRY_PASSWORD}" | base64 | tr -d '\n')\"}}}" > /kaniko/.docker/config.json
    - echo $CI_PROJECT_DIR
    - echo $CI_REGISTRY
    - echo $CI_REGISTRY_IMAGE
    - echo $PROJECT_VERSION
    - >-
      /kaniko/executor
      --context "${CI_PROJECT_DIR}"
      --dockerfile "${CI_PROJECT_DIR}/Dockerfile"
      --destination "${CI_REGISTRY_IMAGE}:${CI_COMMIT_SHA}"
  when: manual

build and push docker image:
  extends: .build_image
    
